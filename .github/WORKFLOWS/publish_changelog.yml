# =============================================================================
# WEBSITE REPO WORKFLOW TEMPLATE
# =============================================================================
# Copy this file to: scanopy/website/.github/workflows/publish_changelog.yml
# =============================================================================

name: Publish Changelog

on:
  pull_request:
    types: [closed]
    paths:
      - 'src/lib/changelog/*.md'

jobs:
  publish:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract changelog content
        id: changelog
        run: |
          # Find the changed changelog file
          CHANGELOG_FILE=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} \
            | grep 'src/lib/changelog/' | head -1)

          if [ -z "$CHANGELOG_FILE" ]; then
            echo "No changelog file found"
            exit 1
          fi

          echo "file=$CHANGELOG_FILE" >> $GITHUB_OUTPUT
          echo "Processing: $CHANGELOG_FILE"

          # Extract frontmatter fields
          VERSION=$(grep '^version:' "$CHANGELOG_FILE" | head -1 | sed 's/version: *//')
          TITLE=$(grep '^title:' "$CHANGELOG_FILE" | head -1 | sed 's/title: *//')
          SOCIAL_POST=$(grep '^social_post:' "$CHANGELOG_FILE" | head -1 | sed 's/social_post: *//')
          CONTRIBUTORS=$(grep '^contributors:' "$CHANGELOG_FILE" | head -1 | sed 's/contributors: *//')

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "social_post=$SOCIAL_POST" >> $GITHUB_OUTPUT
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT

          # Extract body (everything after the closing ---)
          BODY=$(sed -n '/^---$/,/^---$/!p' "$CHANGELOG_FILE" | tail -n +2)

          # Store body with delimiter for multiline
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "body<<$EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

          echo "Version: $VERSION"
          echo "Title: $TITLE"

      - name: Send Discord notification
        env:
          RELEASE_CHANNEL_WEBHOOK: ${{ secrets.RELEASE_CHANNEL_WEBHOOK }}
          VERSION: ${{ steps.changelog.outputs.version }}
          TITLE: ${{ steps.changelog.outputs.title }}
          BODY: ${{ steps.changelog.outputs.body }}
        run: |
          # Truncate body if too long for Discord (max 4096 for embed description)
          TRUNCATED="${BODY:0:3800}"
          if [ ${#BODY} -gt 3800 ]; then
            TRUNCATED="${TRUNCATED}...\n\n[Read full changelog](https://scanopy.net/changelog)"
          fi

          # Escape for JSON
          TRUNCATED=$(echo "$TRUNCATED" | jq -Rs .)

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"v${VERSION}: ${TITLE}\",
                \"url\": \"https://scanopy.net/changelog\",
                \"description\": ${TRUNCATED},
                \"color\": 5814783,
                \"footer\": {
                  \"text\": \"Scanopy Release\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$RELEASE_CHANNEL_WEBHOOK"

          echo "Discord notification sent"

      - name: Post to Twitter/X
        uses: noweh/post-tweet-v2-action@v1.0
        with:
          message: |
            Scanopy v${{ steps.changelog.outputs.version }}: ${{ steps.changelog.outputs.title }}

            ${{ steps.changelog.outputs.social_post }}

            https://scanopy.net/changelog?utm_source=twitter&utm_medium=social&utm_campaign=release_v${{ steps.changelog.outputs.version }}

            #Scanopy #NetworkDiscovery #OpenSource #SelfHosted #NetworkVisualization #NetworkDocumentation #NetworkMapper
          consumer-key: ${{ secrets.TWITTER_CONSUMER_KEY }}
          consumer-secret: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          access-token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          access-token-secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}

      - name: Post to Bluesky
        uses: myConsciousness/bluesky-post@v5
        with:
          text: |
            Scanopy v${{ steps.changelog.outputs.version }}: ${{ steps.changelog.outputs.title }}

            ${{ steps.changelog.outputs.social_post }}

            https://scanopy.net/changelog?utm_source=bluesky&utm_medium=social&utm_campaign=release_v${{ steps.changelog.outputs.version }}

            #Scanopy #NetworkDiscovery #OpenSource #SelfHosted #NetworkVisualization #NetworkDocumentation #NetworkMapper
          identifier: ${{ secrets.BLUESKY_IDENTIFIER }}
          password: ${{ secrets.BLUESKY_PASSWORD }}

      # - name: Post to Reddit
      #   uses: bluwy/release-for-reddit-action@v2
      #   with:
      #     username: ${{ secrets.REDDIT_USERNAME }}
      #     password: ${{ secrets.REDDIT_PASSWORD }}
      #     app-id: ${{ secrets.REDDIT_APP_ID }}
      #     app-secret: ${{ secrets.REDDIT_APP_SECRET }}
      #     subreddit: scanopy
      #     title: "Scanopy v${{ steps.changelog.outputs.version }}: ${{ steps.changelog.outputs.title }}"
      #     text: |
      #       ${{ steps.changelog.outputs.social_post }}

      #       **What's New:**

      #       ${{ steps.changelog.outputs.body }}

      #       ---

      #       [Full changelog on scanopy.net](https://scanopy.net/changelog?utm_source=reddit&utm_medium=social&utm_campaign=release_v${{ steps.changelog.outputs.version }})

      #       #Scanopy #NetworkDiscovery #OpenSource #SelfHosted
